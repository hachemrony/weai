<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WeAI – Moderation Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:," />

  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: var(--bg); color: var(--text); }
    header { padding: 16px 20px; border-bottom: 1px solid #1f2937; display:flex; gap:16px; align-items:center; }
    header h1 { margin:0; font-size: 18px; letter-spacing: .5px; }
    .pill { padding: 6px 10px; background:#0b1220; border:1px solid #1f2937; border-radius: 10px; display:flex; gap:8px; align-items:center; }
    input[type="password"], input[type="text"] { background:#0b1220; color:var(--text); border:1px solid #1f2937; border-radius: 8px; padding:8px 10px; min-width:280px; }
    button { border:1px solid #1f2937; background:#0b1220; color:var(--text); padding:8px 12px; border-radius:8px; cursor:pointer; }
    button:hover { border-color:#334155; }
    button.approve { border-color:#14532d; }
    button.reject  { border-color:#7f1d1d; }
    button.small { padding:6px 10px; font-size: 13px; }
    main { padding: 18px 20px; display:grid; gap:14px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .cards { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .card { background:var(--panel); border:1px solid #1f2937; border-radius: 12px; padding:14px; display:flex; flex-direction:column; gap:10px; }
    .meta { font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap; }
    .content { white-space: pre-wrap; line-height:1.35; }
    .badges { display:flex; gap:8px; flex-wrap:wrap; }
    .badge { font-size:11px; padding:3px 6px; border-radius: 999px; border:1px solid #334155; color:#cbd5e1; }
    .badge.flag { border-color: var(--warn); color: #fde68a; }
    .badge.illicit { border-color: #4c1d95; color:#e9d5ff; }
    .footer { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .muted { color:var(--muted); font-size:12px; }
    .right { display:flex; gap:8px; }
    .notice { background:#0b1220; border:1px solid #1f2937; padding:10px 12px; border-radius:10px; }
    .ok { color:var(--accent); }
    .err { color:var(--danger); }
    .divider { height:1px; background:#1f2937; margin:8px 0; }

    /* lightweight inline spinner + disabled look */
    .spinner{display:inline-block;width:12px;height:12px;border:2px solid currentColor;border-right-color:transparent;border-radius:50%;animation:spin .8s linear infinite;vertical-align:-2px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .btn-ghost[disabled], .btn[disabled]{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <header>
    <h1>WeAI – Moderation Admin</h1>
    <div class="pill">
      <span class="muted">Token</span>
      <select id="providerSelect" class="ml-2 text-xs px-2 py-1 rounded bg-slate-800 text-slate-200">
        <option value="">default</option>
        <option value="mock">mock</option>
        <option value="pika">pika</option>
        <option value="comfy">comfy</option>
      </select>      
      <input id="token" type="password" placeholder="x-admin-token..." />
      <span id="provider-badge" class="ml-3 text-xs px-2 py-1 rounded-full bg-slate-700 text-slate-200">
        provider: …
      </span>      
      <button id="saveToken" class="small">Save</button>
      <span id="tokenState" class="muted">not set</span>
    </div>
    <!-- add this toolbar row right after the pill -->
    <div class="row" style="gap:8px; align-items:center;">
        <button id="btn-refresh-queue">Refresh queue</button>
        <button id="btn-view-audit">View audit</button>
        <button id="btn-prev" class="muted">‹ Prev</button>
        <span id="page-info" class="muted">Page 1</span>
        <button id="btn-next" class="muted">Next ›</button>
        <button id="btn-view-posts">View posts</button>  
        <span id="rl" class="muted">Rate limit: –</span>
        <button id="btn-seed" class="muted">Seed 25 demo posts</button>

    </div>
  </header>

  <main>
    <div id="status" class="notice muted">Ready.</div>
    <div id="cards" class="cards"></div>
  </main>

  <script>
    // --- provider override (admin-only) ---
    const providerSelect = document.getElementById('providerSelect');
    if (providerSelect) {
        // restore previous choice
        const saved = localStorage.getItem('visual_provider_override') || '';
        providerSelect.value = saved;
        providerSelect.addEventListener('change', () => {
            localStorage.setItem('visual_provider_override', providerSelect.value || '');
        });
    }

    // helper: get current override value
    function getProviderOverride() {
        const el = document.getElementById('providerSelect');
        const v = el ? (el.value || '') : '';
        return v === 'default' ? '' : v; // optional nicety
    }

    // Generate visual -> queue job, poll until done, then refresh the list


    document.addEventListener('click', async (e) => {
        // --- Attach media flow ---
    const attachBtn = e.target.closest('.btn-attach');
    if (attachBtn) {
        const postId = attachBtn.dataset.id;
        if (!postId) return;

        // quick inline UI – paste a public MP4 URL (or your /mock/ path)
        const url = prompt('Paste a video URL (mp4) or a local /mock/ path:', '/mock/visuals/demo.mp4');
        if (!url) return;

        busyEl(attachBtn, true); // optional: if you use the busy helper
        setStatus('Attaching...', 'ok');

        try {
        const r = await fetch(`/api/v1/posts/${postId}/media`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
            url,
            provider: 'manual',
            kind: 'video',
            type: 'video/mp4'
            })
        });
        if (!r.ok) throw new Error('Attach failed');
        // refresh current view (same code path you use after generation)
        if (currentView === 'queue')      await loadQueue(currentPage, currentLimit);
        else if (currentView === 'audit') await loadAudit(currentPage, currentLimit);
        else                              await loadPosts(currentPage, currentLimit);
        setStatus('Attached!', 'ok');
        } catch (err) {
        console.warn(err);
        setStatus('Attach failed', 'err');
        alert('Attach failed. Check console/server logs.');
        } finally {
        busyEl(attachBtn, false);
        }

        return; // stop – we handled this click
    }
        const btn = e.target.closest('.btn-visual');
        if (!btn) return;

        const postId = btn.dataset.id;
        if (!postId) return;

        const card = btn.closest('.card');

        // prevent double submits on same card
        if (card && card.dataset.busy === '1') return;
        if (card) card.dataset.busy = '1';

        btn.disabled = true;
        btn.dataset.old = btn.textContent;
        btn.innerHTML = '<span class="spinner"></span> Queueing…';

        const reset = () => { btn.disabled = false; btn.textContent = 'Generate visual'; };

        btn.disabled = true;
        btn.textContent = 'Queuing…';


        try {
            const createRes = await fetch('/api/v1/visuals', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                postId,
                mode: 'animate',
                instruction: 'gentle camera pan, slight nod',
                preset: 'pan',
                durationSec: 4
                })
            });

            const createData = await createRes.json();
            const jobId = createData?.id || createData?.jobId;
            if (!jobId) throw new Error('No job id returned');

            // --- 2) UI CUES (after job was created successfully) ---

            btn.innerHTML = '<span class="spinner"></span> Generating…';
            const notice = document.getElementById('status');
            if (notice) { notice.textContent = 'Generating visual…'; notice.classList.add('ok'); notice.classList.remove('err'); }

            // include admin token if you already do elsewhere
            const headers = {};
            const token = document.getElementById('token')?.value?.trim();
            if (token) headers['x-admin-token'] = token;
            const override = getProviderOverride();
            if (override) headers['x-visual-provider'] = override;

            // 2) poll status
            btn.textContent = 'Generating…';
            const poll = async () => {
            const { data: job } = await api(`/api/v1/visuals/${jobId}`);
            if (job.status === 'finished' || job.status === 'completed') return job;
            if (job.status === 'failed') throw new Error(job.error || 'Generation failed');
            await new Promise(r => setTimeout(r, 1200));
            return poll();
            };

            await (async function poll() {
            while (true) {
                const r = await fetch(`/api/v1/visuals/${jobId}`, { headers });
                const j = await r.json();
                if (j.status === 'finished') return;
                if (j.status === 'failed') throw new Error('Generation failed');
                await new Promise(r => setTimeout(r, 1200));
            }
            })();

            // 3) refresh the current view (the worker attached media to the post)
            btn.textContent = 'Refreshing…';
            if (currentView === 'queue')      await loadQueue(currentPage, currentLimit);
            else if (currentView === 'audit') await loadAudit(currentPage, currentLimit);
            else                               await loadPosts(currentPage, currentLimit);

        } catch (err) {
            setStatus(err.message || String(err), 'err');
            
        if (notice) notice.textContent = 'Ready.';

        } finally {
            reset();
            if (card) card.dataset.busy = '0';
            btn.disabled = false;
            btn.textContent = btn.dataset.old || 'Generate visual';
        }   
    });

    // --- tiny helpers ---
    const $ = (q) => document.querySelector(q);
    const setStatus = (msg, kind = 'ok') => {
      const bar = $('#status');
      if (!bar) return;
      bar.textContent = msg;
      bar.className = kind; // css colors .ok / .err
    };

    function busy(el, on, labelBusy = '…') {
        if (!el) return;
        if (on) {
            if (!el.dataset._label) el.dataset._label = el.textContent;
            el.textContent = labelBusy;
            el.disabled = true;
        } else {
            el.textContent = el.dataset._label || el.textContent;
            delete el.dataset._label;
            el.disabled = false;
        }
    }


    let currentView = 'queue';   // 'queue' | 'audit' | 'posts' (if you use it later)
    let currentPage = 1;
    let currentLimit = 20;
    let lastTotal = 0;           // from API

    // --- pager helpers ---
    function totalPages() {
        const total = Number.isFinite(lastTotal) ? lastTotal : 0;
        const per   = currentLimit || 1;
        return Math.max(1, Math.ceil(total / per));
    }

    function updatePager() {
        const lbl  = document.getElementById('page-info');   // must match HTML id
        const prev = document.getElementById('btn-prev');
        const next = document.getElementById('btn-next');
        const pages = totalPages();

        if (lbl)  lbl.textContent = `Page ${currentPage} / ${pages}`;
        if (prev) prev.disabled   = currentPage <= 1;
        if (next) next.disabled   = currentPage >= pages;
    }

    async function goPrev() {
        if (currentPage <= 1) return;
        const p = currentPage - 1;
        if (currentView === 'queue') return loadQueue(p, currentLimit);
        if (currentView === 'audit') return loadAudit(p, currentLimit);
        return loadPosts(p, currentLimit); // if you have posts view
    }

    async function goNext() {
        if (currentPage >= totalPages()) return;
        const p = currentPage + 1;
        if (currentView === 'queue') return loadQueue(p, currentLimit);
        if (currentView === 'audit') return loadAudit(p, currentLimit);
        return loadPosts(p, currentLimit); // if you have posts view
    }
    async function paintProviderHealth() {
        try {
            const r = await fetch('/api/v1/visuals/health');
            const { name, fallback, ready } = await r.json();
            const notice = document.getElementById('status'); // you already have .notice styles

            if (!ready && fallback === 'mock') {
            notice.classList.remove('ok');
            notice.classList.add('err');
            notice.textContent = `Provider ${name} not configured — using mock fallback.`;
            } else {
            notice.classList.remove('err');
            notice.classList.add('ok');
            notice.textContent = `Ready. Provider: ${name}${fallback ? ` (fallback: ${fallback})` : ''}.`;
            }

        } catch (e) {
            // don’t crash UI; leave existing text
            console.warn('health banner error', e);
        }
    }

    // call on load (alongside your paintProviderBadge)
    paintProviderHealth();

    document.getElementById('btn-seed')?.addEventListener('click', async () => {
        const btn = document.getElementById('btn-seed');
        btn.disabled = true;
        try {
            for (let i = 1; i <= 25; i++) {
            await fetch('/api/v1/posts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ personaId: 'TEMP-ALFA', content: `Hello ${i}`, tags: [] })
            });
            }
            setStatus('Seeded 25 posts', 'ok');
        } catch (e) {
            setStatus(e.message || String(e), 'err');
        } finally {
            btn.disabled = false;
        }
    });


    // --- token-aware fetch wrapper ---
    async function api(path, opts = {}) {
      const token   = (localStorage.getItem('admin_token') || '').trim();
      const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
      if (token) {
        headers['x-admin-token'] = token;           // our middleware accepts this
        headers['Authorization'] = `Bearer ${token}`; // and this (belt + suspenders)
      }
    
      const res  = await fetch(path, { cache: 'no-store', ...opts, headers });
      const ct   = res.headers.get('content-type') || '';
      const body = ct.includes('application/json') ? await res.json() : await res.text();
    
      if (!res.ok) {
        throw new Error(`HTTP ${res.status} ${res.statusText} — ${typeof body === 'string' ? body : JSON.stringify(body)}`);
      }
      return { data: body, headers: res.headers, status: res.status };
    }

    // after your other listeners:
    document.getElementById('btn-refresh-queue')?.addEventListener('click', () => {
        currentView = 'queue';
        currentPage = 1;
        currentLimit = 20;
        loadQueue(currentPage, currentLimit);
        updatePager();
     });

    document.getElementById('btn-view-audit')?.addEventListener('click', () => {
        currentView = 'audit';
        currentPage = 1;
        currentLimit = 30;
        loadAudit(currentPage, currentLimit);
        updatePager();
     });

    document.getElementById('goto')?.addEventListener('change', e=>{
        const p = Math.max(1, Math.min(+e.target.value|0, totalPages()));
        if (currentView==='queue') loadQueue(p, currentLimit);
        else if (currentView==='audit') loadAudit(p, currentLimit);
        else loadPosts(p, currentLimit);
    });

    
    function updateRateLimit(headers) {
      const lim = headers?.get('x-ratelimit-limit');
      const rem = headers?.get('x-ratelimit-remaining');
      const el  = document.getElementById('rl'); // existing span
      if (!el) return;
      el.textContent = lim ? `Rate limit: ${rem}/${lim}` : 'Rate limit: –';
    }
    
    // --- render cards ---
    function renderItems(items, mode = 'queue') {
    const cards = document.querySelector('#cards');
    cards.innerHTML = '';
    if (!items.length) { cards.innerHTML = '<div class="muted">No items.</div>'; return; }

    for (const it of items) {
        const badges = [];

        if (mode === 'queue') {
        if (it.verdict?.flagged) badges.push('<span class="badge flag">flagged</span>');
        for (const [k, v] of Object.entries(it.verdict?.categories || {})) {
            if (v === true) badges.push(`<span class="badge ${k}">${k}</span>`);
        }
        } else if (mode === 'posts') {
        if (Array.isArray(it.tags) && it.tags.length) {
            for (const t of it.tags) badges.push(`<span class="badge">${t}</span>`);
        } else {
            badges.push('<span class="badge">post</span>');
        }
        } else {
        badges.push(`<span class="badge">${it.type || 'audit'}</span>`);
        }

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
        <div class="meta">
            <span>ID: ${it.id || it._id || '–'}</span>
            ${it.personaId ? `<span>persona: ${it.personaId}</span>` : ''}
            ${it.createdAt ? `<span>${new Date(it.createdAt).toLocaleString()}</span>` : ''}
        </div>
        <div class="badges">${badges.join(' ')}</div>
        <div class="content">${
            String(it.content || '').replace(/[<>&]/g, s => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))
        }</div>

        <div class="footer">
            <div class="left">
                <span class="muted">
                ${mode === 'posts' ? 'Published post' : mode === 'queue' ? 'Pending review' : 'Audit record'}
                </span>
            </div>
            <div class="right">
                <button type="button" class="small btn-visual" data-id="${it.id}">Generate visual</button>
                <button type="button" class="small btn-attach" data-id="${it.id}">Attach media</button>
                ${mode === 'queue'
                ? `<button type="button" class="approve" data-act="approve" data-id="${it.id}">Approve</button>
                    <button type="button" class="reject"  data-act="reject"  data-id="${it.id}">Reject</button>`
                : ''
                }
            </div>
        </div>
       `;

        // --- provider pill ---
        const media     = (it.media && it.media[0]) || null;
        const provider  = (media && media.provider) || 'none';

        const pillClass =
            provider === 'mock'  ? 'bg-gray-700'   :
            provider === 'pika'  ? 'bg-purple-700' :
            provider === 'comfy' ? 'bg-emerald-700':
                                    'bg-slate-700';

        const providerRow = document.createElement('div');
        providerRow.className = 'mt-2 text-xs text-slate-300';
        providerRow.innerHTML = `
            provider:
            <span class="inline-block px-2 py-0.5 rounded-full ${pillClass}">
                ${provider}
            </span>
        `;

        // put the pill at the top of the card body
        (card.querySelector('.content') || card).prepend(providerRow);


        const contentEl = card.querySelector('.content');
            if (
            contentEl &&
            Array.isArray(it.media) &&
            it.media.length &&
            it.media[0] &&
            it.media[0].url
            ) {
            const vid = document.createElement('video');
            vid.src = it.media[0].url;
            vid.controls = true;
            vid.preload = 'metadata';
            vid.style.width = '100%';
            vid.style.marginTop = '8px';
            vid.style.borderRadius = '12px';
            contentEl.appendChild(vid);
        }
       cards.appendChild(card);
     }
    }

    
    // --- loaders ---
    async function loadQueue(page = 1, limit = 20) {
        setStatus('Loading queue…');
        const btn = document.getElementById('btn-refresh-queue');
        busy(btn, true, 'Refreshing…');
        try {
            const { data, headers } =
            await api(`/api/v1/modqueue?page=${page}&limit=${limit}&t=${Date.now()}`);
            updateRateLimit(headers);

            currentView  = 'queue';
            currentPage  = page;
            currentLimit = limit;
            lastTotal    = data.total ?? (Array.isArray(data.items) ? data.items.length : 0);

            renderItems(data.items, 'queue');
            updatePager();
            setStatus('Queue loaded', 'ok');
        } catch (err) {
            setStatus(err.message || String(err), 'err');
        } finally {
            busy(btn, false);
        }
    }
    

    async function loadAudit(page = 1, limit = 10) {
        setStatus('Loading audit…');
        const btn = document.getElementById('btn-view-audit');
        busy(btn, true, 'Loading…');
        try {
            const { data, headers } =
            await api(`/api/v1/audit?page=${page}&limit=${limit}&t=${Date.now()}`);
            updateRateLimit(headers);

            currentView  = 'audit';
            currentPage  = page;
            currentLimit = limit;
            lastTotal    = data.total ?? (Array.isArray(data.items) ? data.items.length : 0);

            renderItems(data.items, 'audit');
            updatePager();
            setStatus('Audit loaded', 'ok');
        } catch (err) {
            setStatus(err.message || String(err), 'err');
        } finally {
            busy(btn, false);
        }
    }

    async function loadPosts(page = 1, limit = 20) {
        setStatus('Loading posts…');
        const btn = document.getElementById('btn-view-posts');
        busy(btn, true, 'Loading…');
        try {
            const { data, headers } =
            await api(`/api/v1/posts?page=${page}&limit=${limit}&t=${Date.now()}`);
            updateRateLimit(headers);

            currentView  = 'posts';
            currentPage  = page;
            currentLimit = limit;
            lastTotal    = data.total ?? (Array.isArray(data.items) ? data.items.length : 0);

            renderItems(data.items, 'posts');
            updatePager();
            setStatus('Posts loaded', 'ok');
        } catch (err) {
            setStatus(err.message || String(err), 'err');
        } finally {
            busy(btn, false);
        }
    }

    async function paintProviderBadge() {
        try {
            const r = await fetch('/api/v1/visuals/provider');
            const { name, fallback } = await r.json();

            const el = document.getElementById('provider-badge');
            if (!el) return;

            el.textContent = fallback
            ? `provider: ${name} (mock fallback)`
            : `provider: ${name}`;

            // quick styling cue
            el.classList.remove('bg-slate-700','bg-amber-700','bg-emerald-700');
            el.classList.add(fallback ? 'bg-amber-700' : 'bg-emerald-700');
        } catch (e) {
            // best-effort: leave the default
            console.warn('provider badge error', e);
        }
    }

    // call on load
    paintProviderBadge();

    // --- one-time wiring ---
    document.addEventListener('DOMContentLoaded', () => {
      // token field + save
      const tokenInput  = document.getElementById('token');
      const tokenState  = document.getElementById('tokenState');
      const saveBtn     = document.getElementById('save');
    
      const saved = localStorage.getItem('admin_token') || '';
      if (tokenInput) tokenInput.value = saved;
      if (tokenState) tokenState.textContent = saved ? 'saved' : 'not set';
    
      saveBtn?.addEventListener('click', () => {
        const val = (tokenInput?.value || '').trim();
        localStorage.setItem('admin_token', val);
        if (tokenState) tokenState.textContent = val ? 'saved' : 'not set';
        setStatus('saved', 'ok');
      });
    
      // buttons (support both id styles)
      const btnRefresh = document.getElementById('btn-refresh-queue') || document.getElementById('btnQueue');
      const btnAudit   = document.getElementById('btn-view-audit')    || document.getElementById('btnAudit');
      const btnQueue = document.getElementById('btn-refresh-queue');
      const btnPosts = document.getElementById('btn-view-posts');
      const btnPrev  = document.getElementById('btn-prev');
      const btnNext  = document.getElementById('btn-next');
    
      btnRefresh?.addEventListener('click', () => loadQueue());
      btnQueue?.addEventListener('click', () => {
        currentView  = 'queue';
        currentPage  = 1;
        currentLimit = 20;
        loadQueue(currentPage, currentLimit);
      });

      btnAudit?.addEventListener('click', () => {
        currentView  = 'audit';
        currentPage  = 1;
        currentLimit = 10;
        loadAudit(currentPage, currentLimit);
      });

      btnPosts?.addEventListener('click', () => {
        currentView  = 'posts';
        currentPage  = 1;
        currentLimit = 20;
        loadPosts(currentPage, currentLimit);
      });

    // pager
      btnPrev?.addEventListener('click', goPrev);
      btnNext?.addEventListener('click', goNext);
    
      // approve / reject (event delegation)
      document.getElementById('cards')?.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-act]');
        if (!btn) return;
    
        const id  = btn.dataset.id;
        const act = btn.dataset.act;
        try {
          btn.disabled = true;
          const res = await api(`/api/v1/modqueue/${encodeURIComponent(id)}/${act}`, { method: 'POST' });
          updateRateLimit(res.headers);
          setStatus(`✓ ${act} OK for ${id}`, 'ok');
          await loadQueue();
        } catch (err) {
          setStatus(err.message || String(err), 'err');
        } finally {
          btn.disabled = false;
        }
      });
    
      // initial population
      saved ? loadQueue() : setStatus('Enter admin token and click Save', 'err');
    });
    </script>
    
  
</body>
</html>
